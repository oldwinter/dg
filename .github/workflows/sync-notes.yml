name: åŒæ­¥æ•°å­—èŠ±å›­ç¬”è®°

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘ - æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 * * * *'
  
  # å½“åŒæ­¥è„šæœ¬è¢«ä¿®æ”¹æ—¶è§¦å‘
  push:
    paths:
      - 'sync_notes.py'
      - 'requirements.txt'
      - '.github/workflows/sync-notes.yml'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºå½“å‰ä»“åº“
      uses: actions/checkout@v4
      with:
        # éœ€è¦å®Œæ•´å†å²ä»¥ä¾¿æäº¤æ›´æ”¹
        fetch-depth: 0
        # ä½¿ç”¨ Personal Access Token ä»¥ä¾¿æ¨é€æ›´æ”¹
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: é…ç½®Git
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
    
    - name: æ£€æŸ¥æºä»“åº“æ˜¯å¦æœ‰æ›´æ–°
      id: check_updates
      run: |
        # è·å–æºä»“åº“æœ€æ–°æäº¤æ—¶é—´
        LATEST_COMMIT=$(git ls-remote https://github.com/oldwinter/dg3.git HEAD | cut -f1)
        echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•çš„ä¸Šæ¬¡åŒæ­¥æäº¤
        if [ -f ".last_sync_commit" ]; then
          LAST_SYNC=$(cat .last_sync_commit)
          echo "last_sync=$LAST_SYNC" >> $GITHUB_OUTPUT
        else
          echo "last_sync=" >> $GITHUB_OUTPUT
        fi
        
        # æ¯”è¾ƒæäº¤å“ˆå¸Œ
        if [ "$LATEST_COMMIT" != "$LAST_SYNC" ]; then
          echo "éœ€è¦åŒæ­¥"
          echo "needs_sync=true" >> $GITHUB_OUTPUT
        else
          echo "æ— éœ€åŒæ­¥"
          echo "needs_sync=false" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    

    
    - name: æ‰§è¡ŒåŒæ­¥
      if: steps.check_updates.outputs.needs_sync == 'true'
      run: |
        echo "å¼€å§‹åŒæ­¥ç¬”è®°..."
        python sync_notes.py --verbose
        
        # è®°å½•æœ¬æ¬¡åŒæ­¥çš„æäº¤å“ˆå¸Œ
        echo "${{ steps.check_updates.outputs.latest_commit }}" > .last_sync_commit
    
    - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      if: steps.check_updates.outputs.needs_sync == 'true'
      id: check_changes
      run: |
        git add .
        if git diff --cached --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°å˜æ›´"
        fi
    
    - name: æäº¤å¹¶æ¨é€å˜æ›´
      if: steps.check_updates.outputs.needs_sync == 'true' && steps.check_changes.outputs.has_changes == 'true'
      run: |
        git commit -m "ğŸ¤– è‡ªåŠ¨åŒæ­¥ç¬”è®°ä» dg3 ä»“åº“
        
        - åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - æºæäº¤: ${{ steps.check_updates.outputs.latest_commit }}
        - åŒæ­¥æ–‡ä»¶æ•°: $(find _notes -name '*.md' | wc -l)
        "
        git push
    
    - name: è¾“å‡ºåŒæ­¥ç»“æœ
      run: |
        if [ "${{ steps.check_updates.outputs.needs_sync }}" == "true" ]; then
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… åŒæ­¥å®Œæˆå¹¶æ¨é€äº†å˜æ›´"
          else
            echo "âœ… åŒæ­¥å®Œæˆä½†æ²¡æœ‰å˜æ›´"
          fi
        else
          echo "â„¹ï¸ æºä»“åº“æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
        fi 